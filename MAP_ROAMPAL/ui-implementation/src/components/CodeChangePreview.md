# CodeChangePreview.tsx - Map

## Summary

`CodeChangePreview.tsx` is a specialized component for reviewing and managing proposed code changes (diffs) generated by an LLM. It allows users to inspect individual file changes, see added/removed line counts, and either apply or skip changes individually or in bulk. It mimics a git-like review interface with color-coded diff highlights.

---

## Technical Map

### Core Dependencies

- **Icons**: `lucide-react` (FileText, Check, X, ChevronDown, ChevronUp, GitBranch, AlertCircle).

### Data Structures

#### `CodeChange` Interface (Lines 4-12)

- `change_id`: Unique identifier for the change.
- `file_path`: Path to the file being modified.
- `diff`: The actual unified diff string.
- `description`: A brief summary of what the change does.
- `status`: Current lifecycle state (`pending`, `applied`, `skipped`).
- `lines_added` / `lines_removed`: Statistical metadata for the diff.

### Component Props (`CodeChangePreviewProps`)

- `changes`: Array of `CodeChange` objects to display.
- `onApply`: Callback for applying a single change.
- `onSkip`: Callback for skipping a single change.
- `onApplyAll`: Callback for applying all pending changes.

### Component Logic

- **State Management**:
  - `expandedChanges`: A `Set` of IDs for diffs that are currently toggled open.
  - `appliedChanges` / `skippedChanges`: Tracks local UI status for immediate feedback before backend sync.
- **Bulk Actions (Line 51)**: `handleApplyAll` calculates all remaining IDs and triggers the global callback.
- **Diff Parsing (Lines 177-194)**: Iterates through the `diff` string and applies CSS classes based on line prefixes:
  - `+`: Green text/background (added).
  - `-`: Red text/background (removed).
  - `@@`: Blue background (hunk header).

### UI Structure

- **Global Container**: A `zinc-900` box with a border and internal division.
- **Header (Lines 66-87)**: Shows the total count of pending changes and the "Apply All" button.
- **Changes List (Lines 91-201)**:
  - **Change Entry**: Clickable header for expansion, showing file path and description.
  - **Status Badges**: Visual indicators (Applied/Skipped) once a decision is made.
  - **Action Buttons**: "Apply" and "Skip" shown only for pending changes.
  - **Diff View**: A `pre` block nested inside the entry, appearing only when expanded.
- **Footer Summary (Lines 205-227)**: A status line showing summary counts of applied and skipped items.
- **Security Warning (Lines 230-237)**: Automatically displays a yellow alert if any of the modified files contain sensitive keywords like `.env` or `config`.

---

## Connection & Dependencies

- Used by the chat interface (specifically `TerminalMessageThread`) to render proposed file system operations.
- Relies on parent callbacks to perform the actual file system mutations (via `useChatStore` or specialized file utils).
